#!/usr/bin/env bash

# space separated list of directories
# sessionizer will treat all children of these directories as projects
# to start a new tmux session in
WORKPLACE_ROOTS=${WORKPLACE_ROOTS:-"~"}

handle_outside_call() {
	if [ "$has_session" == "true" ]; then
		tmux a -t "$selected_name"
	else
		tmux new-session -s "$selected_name" -c "$selected_path"
	fi
	exit 0
}

handle_inside_call() {
	if [ "$has_session" == "true" ]; then
		tmux switch-client -t "$selected_name"
	fi

	tmux new-session -s "$selected_name" -c "$selected_path"
}

#
# Main
#

if [[ $# -eq 1 ]]; then
	selected_path=$1
else
	selected_path=$(find "$WORKPLACE_ROOTS" -mindepth 1 -maxdepth 1 -type l -o -type d | fzf)
fi

if [[ -z $selected_path ]]; then
	exit 0
fi

selected_name=$(basename "$selected_path" | tr . _)
has_session=$(tmux has-session -t="$selected_name" 2>/dev/null && echo "true" || echo "false")

if [[ -z $TMUX ]]; then
	handle_outside_call
else
	handle_inside_call
fi
